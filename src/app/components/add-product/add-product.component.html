<div class="add-product-container p-6 mx-6 bg-white shadow-md rounded-lg">
  <h2 class="text-xl font-bold mb-4">{{ isEditMode ? 'Editar Producto' : 'Agrega Tus Productos' }}</h2>

  <form
    [formGroup]="productForm"
    (ngSubmit)="addProducts()"
    class="grid grid-cols-1 sm:grid-cols-3 items-start mx-6"
  >
  <div class="flex flex-col sm:col-span-2">
    <!-- Nombre -->
    <div class="flex flex-col">
      <label class="font-semibold mb-1">Nombre del Producto</label>
      <input
        type="text"
        formControlName="name"
        class="border rounded p-2 focus:ring focus:ring-blue-300"
        placeholder="Ej: Camiseta"
      />
      <span
        class="text-red-500 text-sm"
        *ngIf="
          productForm.get('name')?.invalid && productForm.get('name')?.touched
        "
      >
        El nombre es obligatorio y debe tener al menos 3 caracteres
      </span>
    </div>

    <!-- Descripción -->
    <div class="flex flex-col">
      <label class="font-semibold mb-1">Descripción</label>
      <textarea
        formControlName="description"
        class="border rounded p-2 focus:ring focus:ring-blue-300"
        placeholder="Descripción del producto"
      ></textarea>
      <span
        class="text-red-500 text-sm"
        *ngIf="
          productForm.get('description')?.invalid &&
          productForm.get('description')?.touched
        "
      >
        La descripción es obligatoria
      </span>
    </div>

    <!-- Precio -->
    <div class="flex flex-col">
      <label class="font-semibold mb-1">Precio</label>
      <input
        type="text"
        formControlName="price"
        (input)="formatPrice($event)"
        class="border rounded p-2 focus:ring focus:ring-blue-300"
        placeholder="$0"
      />
      <span
        class="text-red-500 text-sm"
        *ngIf="
          productForm.get('price')?.invalid && productForm.get('price')?.touched
        "
      >
        El precio es obligatorio y debe ser mayor que 0
      </span>
    </div>

    @if (!this.hasVariants) {
      <!-- Cantidad -->
    <div class="flex flex-col">
      <label class="font-semibold mb-1">Cantidad Disponible</label>
      <input 
        type="number" 
        formControlName="stock" 
        class="border rounded p-2 focus:ring focus:ring-blue-300"
        placeholder="0"
      />
      <span class="text-red-500 text-sm" *ngIf="productForm.get('stock')?.invalid && productForm.get('stock')?.touched && !this.hasVariants">
        La cantidad debe ser al menos 1
      </span>
    </div>
    }

    <br />
    <div class="col-span-full flex items-center mt-2" [class.pointer-events-none]="isEditMode" [class.opacity-50]="isEditMode">
      <label class="inline-flex items-center cursor-pointer">
        <input
          type="checkbox"
          class="sr-only peer"
          (click)="setHasVariants()"
          formControlName="hasVariants"
        />
        <div
          class="relative w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600 dark:peer-checked:bg-blue-600"
        ></div>
        <span class="ms-3 text-sm font-medium text-gray-900 dark:text-gray-300"
          >¿Desea agregar variantes a este producto?</span
        >
      </label>
    </div>

    <!-- Variantes -->
    <div class="col-span-full" *ngIf="hasVariants">
      <h3 class="text-lg font-semibold mt-4 mb-2">Variantes disponibles</h3>

      <!-- Variantes disponibles -->
      <div class="mt-4">
        <div class="flex flex-wrap gap-2">
          @for (variant of variantsAvailable(); track variant.id) {
            <button
              type="button"
              (click)="toggleVariant(variant)"
              class="px-3 py-1.5 rounded-full border text-sm transition
              hover:bg-blue-50 hover:border-blue-400
              "
              [ngClass]="{
                'bg-blue-600 text-white border-blue-600':
                  isVariantSelected(variant.id),
                'bg-white text-gray-700 border-gray-300':
                  !isVariantSelected(variant.id)
              }"
            >
              {{ variant.name }}
            </button>
          }
        </div>

        <!-- Variante seleccionada -->
        <div class="mt-3 text-sm text-gray-700">
          <span class="font-semibold">Variantes seleccionadas:</span>
          <span class="ml-1">
            {{ getSelectedVariantsText() }}
          </span>
        </div>
      </div>

      @if (variants.length > 0) {
        <div formArrayName="variants" class="space-y-2 rounded-lg border p-4 bg-gray-50">
        <div
          *ngFor="let variant of variants.controls; let i = index"
          [formGroupName]="i"
          class="flex gap-2 items-center"
        >
          <input
            type="text"
            placeholder="Tipo (Ej: Color, Talla)"
            formControlName="name"
            class="border rounded p-2 w-1/3"
          />
          <input
            type="text"
            placeholder="Valor (Ej: Rojo, M, Algodón)"
            formControlName="value"
            class="border rounded p-2 w-1/3"
          />
          <input
            type="number"
            placeholder="Stock"
            formControlName="stock"
            class="border rounded p-2 w-1/3"
          />
          <span
            class="text-red-500 text-sm"
            *ngIf="
              productForm.get('quantity')?.invalid &&
              productForm.get('quantity')?.touched
            "
          >
            La cantidad debe ser al menos 1
          </span>
          <button
            type="button"
            (click)="removeVariant(i)"
            class="text-red-500 hover:text-red-700"
          >
            ❌
          </button>
        </div>
      </div>
      }

      <!-- <button
        type="button"
        (click)="addVariant()"
        class="mt-2 px-4 py-2 border border-blue-500 text-blue-500 rounded hover:bg-blue-50"
      >
        + Agregar Variante
      </button> -->
    </div>
    <p *ngIf="message" class="col-span-full text-red-600 mt-4">{{ message }}</p>
  </div>

  <div class="flex flex-col sm:col-span-1 sticky self-start justify-self-center md:justify-self-end">
    <!-- Imagen -->
    <div class="col-span-full">
      <label class="font-semibold">Imagen</label>
      <!-- Contenedor clickable -->
      <label
        for="fileInput"
        class="w-full max-w-xs aspect-square rounded-lg flex items-center justify-center cursor-pointer bg-gray-50 hover:bg-gray-100"
      >
        <!-- Mostrar preview si existe -->
        <img
          [src]="imagePreview"
          alt="Imagen seleccionada"
          class="w-full h-full object-cover rounded-lg"
        />
      </label>
      <input
        id="fileInput"
        type="file"
        class="hidden"
        (change)="onFileSelected($event)"
      />
    </div>

    <!-- Botones -->
    <div class="col-span-full flex justify-end gap-2 mt-4">
      <button
        type="button"
        (click)="closeDialog()"
        class="px-4 py-2 border rounded hover:bg-gray-100"
      >
        Cancelar
      </button>
      <button
        type="submit"
        class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
      >
        {{ isEditMode ? 'Editar' : 'Agregar' }}
      </button>
    </div>
  </div>
    
  </form>
</div>
